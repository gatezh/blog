{{/* Cloudflare Turnstile - lazy load when contact section approaches viewport */}}
{{ if .Site.Params.turnstileSiteKey }}
<script>
  (function() {
    var loaded = false;
    var turnstileWidgetId = null;
    var siteKey = {{ .Site.Params.turnstileSiteKey }};

    // Get current theme (dark if html has .dark class)
    function getCurrentTheme() {
      return document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    }

    function loadTurnstile() {
      if (loaded) return;
      loaded = true;
      var s = document.createElement('script');
      s.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onTurnstileLoad';
      s.async = true;
      document.head.appendChild(s);
    }

    // Called when Turnstile script loads
    window.onTurnstileLoad = function() {
      var container = document.getElementById('turnstile-container');
      if (container && typeof turnstile !== 'undefined') {
        turnstileWidgetId = turnstile.render(container, {
          sitekey: siteKey,
          theme: getCurrentTheme()
        });
      }
    };

    // Re-render Turnstile when theme changes
    window.addEventListener('themechange', function() {
      if (typeof turnstile !== 'undefined' && turnstileWidgetId !== null) {
        var container = document.getElementById('turnstile-container');
        if (container) {
          turnstile.remove(turnstileWidgetId);
          turnstileWidgetId = turnstile.render(container, {
            sitekey: siteKey,
            theme: getCurrentTheme()
          });
        }
      }
    });

    // Load when contact section is 500px from viewport
    var observer = new IntersectionObserver(function(entries) {
      if (entries[0].isIntersecting) {
        loadTurnstile();
        observer.disconnect();
      }
    }, { rootMargin: '500px' });
    document.addEventListener('DOMContentLoaded', function() {
      var contact = document.getElementById('contact');
      if (contact) observer.observe(contact);
    });
  })();
</script>
{{ end }}
