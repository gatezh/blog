{{/* Cloudflare Images Transformations */}}
{{/* https://developers.cloudflare.com/images/transform-images/transform-via-url/ */}}
{{/* Cloudflare image optimization is only enabled for the production domain, */}}
{{/* so the CDN prefix is added only in production environment. */}}

{{- $src := .Get "src" -}}
{{- $alt := .Get "alt" -}}
{{- $caption := .Get "caption" -}}

{{- $img := .Page.Resources.GetMatch $src -}}

{{- if $img }}
<figure>
  {{- $imgSrc := $img.RelPermalink -}}
  {{- if eq hugo.Environment "production" -}}
    {{- $imgSrc = print "/cdn-cgi/image/format=auto,width=auto" $imgSrc -}}
  {{- end }}
  <img
    src="{{ $imgSrc }}"
    alt="{{ $alt | htmlEscape }}"
    loading="lazy"
    style="aspect-ratio: {{ $img.Width }}/{{ $img.Height }}; max-width: 100%; height: auto;"
  >
  {{- with $caption }}
  <figcaption>{{ . | markdownify }}</figcaption>
  {{- end }}
</figure>
{{- end }}
