{{/* Cloudflare Images Transformations */}}
{{/* https://developers.cloudflare.com/images/transform-images/transform-via-url/ */}}
{{/* Cloudflare image optimization is only enabled for the production domain, */}}
{{/* so the CDN prefix is added only in production environment. */}}
{{/*
Parameters:
src - page resource path (required)
alt - alt text for accessibility (required)
caption - figcaption text, supports inline markdown (optional)
scale - max width as % of container on wide screens (optional, default 100)
*/}}

{{- if not (.Page.Store.Get "cfimage-style") }}
{{- .Page.Store.Set "cfimage-style" true }}
<style>
  .cfimage {
    margin: 1rem 0 2rem;
  }

  .cfimage img {
    max-width: 100%;
    height: auto;
  }

  .cfimage figcaption {
    text-align: center;
    font-style: italic;
    margin-top: 0.5rem;
  }

  @media (min-width: 768px) {
    .cfimage[style*="--img-scale"] {
      max-width: calc(var(--img-scale) * 1%);
      margin-inline: auto;
    }
  }
</style>
{{- end }}

{{- $src := .Get "src" -}}
{{- $alt := .Get "alt" -}}
{{- $caption := .Get "caption" -}}
{{- $scale := .Get "scale" -}}

{{- $img := .Page.Resources.GetMatch $src -}}

{{- if $img }}
<figure class="cfimage" {{- if $scale }} style="--img-scale: {{ $scale }}" {{ end -}}>
  {{- $imgSrc := $img.RelPermalink -}}
  {{- if eq hugo.Environment "production" -}}
  {{- $imgSrc = print "/cdn-cgi/image/format=auto,width=auto" $imgSrc -}}
  {{- end }}
  <img src="{{ $imgSrc }}" alt="{{ $alt | htmlEscape }}" loading="lazy"
    style="aspect-ratio: {{ $img.Width }}/{{ $img.Height }};">
  {{- with $caption }}
  <figcaption>{{ . | markdownify }}</figcaption>
  {{- end }}
</figure>
{{- end }}